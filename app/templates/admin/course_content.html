{% extends "base.html" %}


{% block content %}
<div style="display: flex; min-height: 100vh;">
    {% if not student_view %}
    <!-- Sidebar -->
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <span style="font-size: 1.5rem;">&#9776;</span>
    </button>

    <!-- Sidebar -->
    <div class="sidebar">
        <h3 style="margin-bottom: 2rem; padding-left: 1rem; color: var(--accent-primary); font-size: 1.25rem;">Course
            Admin</h3>
        <nav>
            <ul style="list-style: none; padding: 0; margin: 0;">
                <li><a href="{{ url_for('main.dashboard') }}" class="sidebar-link">Dashboard</a></li>
                <li><a href="{{ url_for('admin_bp.categories') }}" class="sidebar-link">Categories</a></li>
                <li><a href="{{ url_for('admin_bp.courses') }}" class="sidebar-link active">Courses</a></li>
                <li><a href="{{ url_for('admin_bp.students') }}" class="sidebar-link">Students</a></li>
                <li style="margin-top: 2rem;">
                    <a href="{{ url_for('auth.logout') }}" class="sidebar-link" style="color: var(--danger);">Logout</a>
                </li>
            </ul>
        </nav>
    </div>
    {% endif %}

    <!-- Main Content -->
    <div class="{{ 'content-wrapper' if not student_view else 'container container-padding-top' }}"
        style="{{ '' if not student_view else 'max-width: 900px; margin: 0 auto; min-height: 100vh;' }}">
        <div class="container" style="max-width: 900px; {{ 'padding: 0;' if student_view else '' }}">

            <!-- Header -->
            <div
                style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 3rem; flex-wrap: wrap; gap: 1rem;">
                <div>
                    {% if not student_view %}
                    <a href="{{ url_for('admin_bp.courses') }}"
                        style="color: var(--text-secondary); text-decoration: none; font-size: 0.9rem; margin-bottom: 0.5rem; display: inline-block;">&larr;
                        Back to Courses</a>
                    {% else %}
                    <a href="{{ url_for('main.student_dashboard') }}"
                        style="color: var(--text-secondary); text-decoration: none; font-size: 0.9rem; margin-bottom: 0.5rem; display: inline-block;">&larr;
                        Back to Dashboard</a>
                    {% endif %}

                    <h1
                        style="margin: 0; font-size: 2.5rem; background: linear-gradient(135deg, white 0%, var(--text-secondary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        {{ course.title }}</h1>

                    <p style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 1.1rem;">Course Material &
                        Curriculum</p>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <!-- Calculate Pending Assignments Logic -->
            {% set ns = namespace(pending_total=0) %}
            {% for mod in course.modules %}
            {% for lsn in mod.lessons %}
            {% if lsn.assignment %}
            {% set p_count = lsn.assignment.submissions | selectattr('grade', 'none') | list | length %}
            {% set ns.pending_total = ns.pending_total + p_count %}
            {% endif %}
            {% endfor %}
            {% endfor %}

            <div class="tab-container">
                <button onclick="switchTab('curriculum')" id="tab-curriculum" class="tab-btn active">
                    Curriculum
                </button>
                <button onclick="switchTab('quizzes')" id="tab-quizzes" class="tab-btn">
                    Quizzes
                </button>
                <button onclick="switchTab('assignments')" id="tab-assignments" class="tab-btn">
                    Assignments
                    {% if ns.pending_total > 0 %}
                    <span
                        style="display:inline-block; width:8px; height:8px; background:var(--danger); border-radius:50%; margin-left:5px; vertical-align: middle;"></span>
                    {% endif %}
                </button>
            </div>

            <!-- Tab Content: Curriculum -->
            <div id="content-curriculum" class="tab-content">
                <!-- Add Module -->
                {% if not student_view %}
                <div class="glass-card"
                    style="margin-bottom: 2rem; border: 1px dashed var(--accent); background: rgba(56, 139, 253, 0.02);">
                    <form action="{{ url_for('admin_bp.add_module', course_id=course.id) }}" method="POST"
                        style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <input type="text" name="title" placeholder="New Module Name (e.g., Week 1: Introduction)"
                            required
                            style="flex: 1; padding: 1rem; background: var(--bg-color); border: 1px solid var(--border); color: white; border-radius: 8px; font-size: 1rem;">
                        <button type="submit" class="btn btn-primary" style="padding: 1rem 2rem;">+ Add Module</button>
                    </form>
                </div>
                {% endif %}

                <!-- Modules List -->
                {% for module in course.modules %}
                <div style="margin-bottom: 2.5rem;">
                    <div
                        style="margin-bottom: 1rem; padding-left: 0.5rem; border-left: 3px solid var(--accent); display: flex; justify-content: space-between; align-items: baseline;">
                        <h2 style="margin: 0; font-size: 1.5rem; color: white;">{{ module.title }}</h2>
                        <span style="font-size: 0.9rem; color: var(--text-secondary);">{{ module.lessons|length }}
                            Lessons</span>
                    </div>

                    <div class="glass-card" style="padding: 0; overflow: hidden; border: 1px solid var(--border);">
                        {% if module.lessons %}
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            {% for lesson in module.lessons %}
                            <li class="lesson-item"
                                onclick="window.location='{{ url_for('main.lesson_player', lesson_id=lesson.id) }}'"
                                style="padding: 1.25rem 1.5rem; cursor: pointer; transition: all 0.2s; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                                <div
                                    style="display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; background: rgba(255,255,255,0.05); border-radius: 50%; color: var(--accent); flex-shrink: 0;">
                                    {% if lesson.id in completed_lesson_ids %}
                                    <span style="color: var(--success); font-size: 1.1rem;">&#10003;</span>
                                    {% else %}
                                    <span>&#9658;</span>
                                    {% endif %}
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <h4 style="margin: 0; font-weight: 500; font-size: 1.05rem; word-wrap: break-word;">
                                        {{ lesson.title }}
                                    </h4>
                                    {% if lesson.quiz %}
                                    <span style="font-size: 0.8rem; color: var(--accent); margin-right: 0.5rem;">[Quiz:
                                        {{ lesson.quiz.questions|length }} Qs]</span>
                                    {% endif %}
                                    {% if lesson.assignment %}
                                    <span style="font-size: 0.8rem; color: var(--accent);">[Assignment]</span>
                                    {% endif %}
                                </div>
                                <div class="lesson-actions" style="display: flex; gap: 0.5rem; align-items: center;">
                                    {% if not student_view %}
                                    <button class="btn btn-sm btn-success edit-lesson-btn" data-id="{{ lesson.id }}"
                                        data-title="{{ lesson.title }}" data-video-url="{{ lesson.video_url }}"
                                        onclick="event.stopPropagation(); openEditLessonModal(this.dataset.id, this.dataset.title, this.dataset.videoUrl)"
                                        style="padding: 0.25rem 0.75rem;">Edit</button>
                                    <button class="btn btn-sm btn-danger margin-left-half"
                                        onclick="event.stopPropagation(); openDeleteModal('{{ url_for('admin_bp.delete_lesson', lesson_id=lesson.id) }}', 'Delete lesson: {{ lesson.title | replace("
                                        \'", "\\\'" ) }}?')" style="padding: 0.25rem 0.75rem;">Del</button>
                                    {% else %}
                                    {% if lesson.assignment %}
                                    <div style="margin-left: 0;">
                                        {% if submissions and submissions.get(lesson.assignment.id) and
                                        submissions[lesson.assignment.id].grade is not none %}
                                        <a href="{{ url_for('main.lesson_player', lesson_id=lesson.id) }}"
                                            class="btn btn-sm btn-soft"
                                            style="text-decoration: none; white-space: nowrap;">
                                            View Score
                                        </a>
                                        {% else %}
                                        <a href="{{ url_for('main.lesson_player', lesson_id=lesson.id) }}"
                                            class="btn btn-sm btn-soft"
                                            style="text-decoration: none; white-space: nowrap;">
                                            Go to Submission
                                        </a>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    {% if lesson.quiz %}
                                    <a href="{{ url_for('main.take_quiz', lesson_id=lesson.id) }}" class="btn btn-sm"
                                        onclick="event.stopPropagation();"
                                        style="background: rgba(59, 130, 246, 0.15); border: 1px solid var(--accent); color: var(--accent); text-decoration: none; white-space: nowrap;">Take
                                        Quiz</a>
                                    {% endif %}
                                    {% endif %}
                                </div>
                                {% endfor %}
                        </ul>
                        {% else %}
                        <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">No lessons yet.
                        </div>
                        {% endif %}

                        <!-- Add Lesson Form -->
                        {% if not student_view %}
                        <div style="padding: 1.5rem; background: rgba(0,0,0,0.2); border-top: 1px solid var(--border);">
                            <form action="{{ url_for('admin_bp.add_lesson', module_id=module.id) }}" method="POST"
                                style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <input type="text" name="title" placeholder="New Lesson Title" required
                                    style="flex: 2; padding: 1rem; background: var(--bg-color); border: 1px solid var(--border); color: white; border-radius: 8px; font-size: 1rem;">
                                <input type="text" name="video_url" placeholder="Video URL (Optional)"
                                    style="flex: 1; padding: 1rem; background: var(--bg-color); border: 1px solid var(--border); color: white; border-radius: 8px; font-size: 1rem;">
                                <button type="submit" class="btn btn-primary"
                                    style="padding: 1rem 2rem; white-space: nowrap;">Add Lesson</button>
                            </form>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div style="text-align: center; padding: 4rem; color: var(--text-secondary);">
                    <p>No modules created yet.</p>
                </div>
                {% endfor %}
            </div>

            <!-- Tab Content: Quizzes -->
            <div id="content-quizzes" class="tab-content" style="display: none;">
                <!-- Quick Add Quiz Button -->
                {% if not student_view %}
                <div class="glass-card"
                    style="margin-bottom: 2rem; padding: 1.5rem; text-align: center; border: 1px dashed var(--accent); background: rgba(56, 139, 253, 0.02);">
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Create a standalone Quiz
                        (automatically creates a lesson holder)</p>
                    <button onclick="openQuickAddModal('quiz')" class="btn btn-primary">+ Create New Quiz</button>
                </div>
                {% endif %}

                <div class="glass-card" style="padding: 0; overflow: hidden; border: 1px solid var(--border);">
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        {% for module in course.modules %}
                        {% for lesson in module.lessons %}
                        {% if lesson.quiz %}
                        <li
                            style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0; font-size: 1.1rem; color: white;">{{ lesson.quiz.title }}</h4>
                                <span style="font-size: 0.9rem; color: var(--text-secondary);">Lesson: {{ lesson.title
                                    }} â€¢ {{ lesson.quiz.questions|length }} Questions</span>
                            </div>
                            <div>
                                {% if not student_view %}
                                <button class="btn btn-sm btn-success"
                                    onclick="event.stopPropagation(); viewQuiz(this.getAttribute('data-title'), this.getAttribute('data-questions'))"
                                    data-title="{{ lesson.quiz.title }}"
                                    data-questions='{{ lesson.quiz.questions_list | tojson | forceescape }}'
                                    style="margin-right: 0.5rem;">
                                    View
                                </button>
                                <a href="{{ url_for('admin_bp.add_quiz', lesson_id=lesson.id) }}"
                                    class="btn btn-sm btn-primary" style="margin-right: 0.5rem;">Edit Quiz</a>
                                <button class="btn btn-sm btn-danger"
                                    onclick="openDeleteModal('{{ url_for('admin_bp.delete_quiz', lesson_id=lesson.id) }}', 'Delete quiz: {{ lesson.quiz.title | replace("
                                    \'", "\\\'" ) }}?')">
                                    Remove
                                </button>
                                {% else %}
                                {% if lesson.quiz.id in quiz_results %}
                                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                    <a href="{{ url_for('main.view_quiz_result', result_id=quiz_results[lesson.quiz.id].id) }}"
                                        class="btn btn-sm"
                                        style="background: rgba(59, 130, 246, 0.15); border: 1px solid var(--accent); color: var(--accent); text-decoration: none;">
                                        View Score
                                    </a>
                                    <a href="{{ url_for('main.take_quiz', lesson_id=lesson.id) }}" class="btn btn-sm"
                                        style="background: transparent; border: 1px solid var(--border); color: var(--text-secondary); text-decoration: none;">
                                        Retake
                                    </a>
                                </div>
                                {% else %}
                                <a href="{{ url_for('main.take_quiz', lesson_id=lesson.id) }}" class="btn btn-sm"
                                    style="background: rgba(59, 130, 246, 0.15); border: 1px solid var(--accent); color: var(--accent); text-decoration: none;">Take
                                    Quiz</a>
                                {% endif %}
                                {% endif %}
                            </div>
                        </li>
                        {% elif not student_view %}
                        <!-- Option to add quiz to lesson? -->
                        {% endif %}
                        {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- Tab Content: Assignments -->
            <div id="content-assignments" class="tab-content" style="display: none;">
                <!-- Quick Add Assignment Button -->
                {% if not student_view %}
                <div class="glass-card"
                    style="margin-bottom: 2rem; padding: 1.5rem; text-align: center; border: 1px dashed var(--accent); background: rgba(56, 139, 253, 0.02);">
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">Create a standalone Assignment
                        (automatically creates a lesson holder)</p>
                    <button onclick="openQuickAddModal('assignment')" class="btn btn-primary">+ Create New
                        Assignment</button>
                </div>
                {% endif %}

                <div class="glass-card" style="padding: 0; overflow: hidden; border: 1px solid var(--border);">
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        {% for module in course.modules %}
                        {% for lesson in module.lessons %}
                        {% if lesson.assignment %}
                        <li
                            style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0; font-size: 1.1rem; color: white;">Assignment for: {{ lesson.title
                                    }}</h4>
                                <span style="font-size: 0.9rem; color: var(--text-secondary);">Max Score: {{
                                    lesson.assignment.max_score }}</span>
                                {% if lesson.assignment.resource_path %}
                                <div style="margin-top: 0.5rem;">
                                    <a href="{{ url_for('main.download_assignment_resource', assignment_id=lesson.assignment.id) }}"
                                        style="color: var(--accent); font-size: 0.85rem; text-decoration: none;">&#128193;
                                        Resource Attached</a>
                                </div>
                                {% endif %}
                            </div>
                            <div>
                                {% if not student_view %}
                                <!-- View Button -->
                                <button class="btn btn-sm btn-success view-assignment-btn"
                                    data-id="{{ lesson.assignment.id }}" data-score="{{ lesson.assignment.max_score }}"
                                    data-instructions="{{ lesson.assignment.instructions }}"
                                    data-resource="{{ lesson.assignment.resource_path|default('', true) }}"
                                    data-resource-url="{{ url_for('main.download_assignment_resource', assignment_id=lesson.assignment.id) if lesson.assignment.resource_path else '' }}"
                                    style="margin-right: 0.5rem; cursor: pointer;">
                                    View
                                </button>

                                <!-- Refactored Edit Button using data attributes to avoid JS errors -->
                                <button class="btn btn-sm btn-primary edit-assignment-btn"
                                    data-id="{{ lesson.assignment.id }}" data-score="{{ lesson.assignment.max_score }}"
                                    data-instructions="{{ lesson.assignment.instructions }}"
                                    data-resource="{{ lesson.assignment.resource_path|default('', true) }}"
                                    style="margin-right: 0.5rem; cursor: pointer;" title="Edit Assignment">Edit</button>

                                <a href="{{ url_for('admin_bp.assignment_submissions', assignment_id=lesson.assignment.id) }}"
                                    class="btn btn-sm btn-dark-green" style="margin-right: 0.5rem;">
                                    Submissions
                                    {% set this_pending = lesson.assignment.submissions | selectattr('grade', 'none') |
                                    list | length %}
                                    {% if this_pending > 0 %}
                                    <span
                                        style="display:inline-block; width:6px; height:6px; background:var(--danger); border-radius:50%; margin-left:3px; vertical-align: middle;"></span>
                                    {% endif %}
                                </a>
                                <button class="btn btn-sm btn-danger"
                                    onclick="openDeleteModal('{{ url_for('admin_bp.delete_assignment', assignment_id=lesson.assignment.id) }}', 'Delete assignment for {{ lesson.title | replace('\'', '\\\'') }}?')">
                                    Remove
                                </button>
                                {% else %}
                                <!-- View Button (Student View) -->
                                <!-- View Details Button Removed as requested -->
                                <a href="{{ url_for('main.lesson_player', lesson_id=lesson.id) }}" class="btn btn-sm"
                                    style="margin-left: 0.5rem; background: rgba(59, 130, 246, 0.15); border: 1px solid var(--accent); color: var(--accent); text-decoration: none;">
                                    {% if submissions and submissions.get(lesson.assignment.id) and
                                    submissions[lesson.assignment.id].grade is not none %}
                                    View Score
                                    {% else %}
                                    Go to Submission
                                    {% endif %}
                                </a>
                                {% endif %}
                            </div>
                        </li>
                        {% elif not student_view %}
                        <li
                            style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; opacity: 0.7;">
                            <span style="color: var(--text-secondary);">{{ lesson.title }} (No Assignment)</span>
                            <a href="#" onclick="openAddAssignmentModal({{ lesson.id }})" class="btn btn-sm btn-primary"
                                style="font-size: 0.9rem; text-decoration: none;">+ Add Assignment</a>
                        </li>
                        {% endif %}
                        {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    .lesson-item {
        padding: 1.25rem 1.5rem;
        cursor: pointer;
        transition: all 0.2s;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .lesson-item:last-child {
        border-bottom: none;
    }

    .lesson-item:hover {
        background: rgba(255, 255, 255, 0.03);
    }

    .action-btn {
        font-size: 0.75rem;
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-secondary);
        text-decoration: none;
        border: none;
        cursor: pointer;
        margin-left: 0.5rem;
        transition: background 0.2s;
    }

    .action-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        color: white;
    }

    .action-btn.delete {
        background: rgba(218, 54, 51, 0.1);
        color: var(--error);
    }

    .action-btn.delete:hover {
        background: rgba(218, 54, 51, 0.2);
    }
</style>

<!-- Add/Edit Assignment Modal -->
{% if not student_view %}
<div id="assignmentModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
    <div class="glass-card" style="width: 500px; max-width: 90%;">
        <h3 id="modalTitle" style="margin-top: 0;">Add Assignment</h3>
        <form id="assignmentForm" method="POST" enctype="multipart/form-data">
            <div class="form-group" style="margin-bottom: 1rem;">
                <label>Max Score</label>
                <input type="number" id="assignScore" name="max_score" value="100" required class="form-control"
                    style="width: 100%; padding: 0.8rem; background: var(--bg-color); border: 1px solid var(--border); color: white; border-radius: 6px;">
            </div>
            <div class="form-group" style="margin-bottom: 1rem;">
                <label>Instructions</label>
                <textarea id="assignInstr" name="instructions" rows="5" class="form-control"
                    placeholder="Detailed instructions for the student..." required
                    style="width: 100%; padding: 0.8rem; background: var(--bg-color); border: 1px solid var(--border); color: white; border-radius: 6px;"></textarea>
            </div>
            <div class="form-group" style="margin-bottom: 2rem;">
                <label>Attach Resource (Optional - PDF, Zip, Doc)</label>

                <!-- Display existing file if any -->
                <div id="currentResourceFile"
                    style="display: none; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(56, 139, 253, 0.1); border-radius: 4px; border: 1px solid var(--accent);">
                    <span style="font-size: 0.9rem; color: var(--accent);">
                        Current File: <span id="currentFileName" style="font-weight: bold;"></span>
                    </span>
                    <br>
                    <small style="color: var(--text-secondary);">Upload new file to replace.</small>
                </div>

                <input type="file" name="resource_file" class="form-control"
                    style="width: 100%; padding: 0.8rem; background: var(--bg-color); border: 1px solid var(--border); color: white; border-radius: 6px;">
            </div>
            <div style="display: flex; gap: 1rem;">
                <button type="button" onclick="document.getElementById('assignmentModal').style.display='none'"
                    class="btn"
                    style="background: transparent; border: 1px solid var(--border); color: var(--text-secondary);">Cancel</button>
                <button type="submit" id="modalSubmitBtn" class="btn btn-primary" style="flex: 1;">Create
                    Assignment</button>
            </div>
        </form>
    </div>
</div>


<!-- Quick Add Modal -->
<div id="quickAddModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
    <div class="glass-card" style="width: 450px; max-width: 90%;">
        <h3 id="quickAddTitle" style="margin-top: 0;">Add Quick Content</h3>
        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1.5rem;">
            This will create a new lesson container for your content.
        </p>
        <form action="{{ url_for('admin_bp.quick_add_content', course_id=course.id) }}" method="POST">
            <input type="hidden" id="quickAddType" name="type" value="quiz">

            <div class="form-group" style="margin-bottom: 1rem;">
                <label>Select Module (Week)</label>
                <select name="module_id" required
                    style="width: 100%; padding: 0.8rem; background: var(--bg-color); border: 1px solid var(--border); color: white; border-radius: 6px;">
                    {% for module in course.modules %}
                    <option value="{{ module.id }}">{{ module.title }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group" style="margin-bottom: 2rem;">
                <label>Title</label>
                <input type="text" name="title" placeholder="e.g. Week 1 Quiz" required
                    style="width: 100%; padding: 0.8rem; background: var(--bg-color); border: 1px solid var(--border); color: white; border-radius: 6px;">
            </div>

            <div style="display: flex; gap: 1rem;">
                <button type="button" onclick="document.getElementById('quickAddModal').style.display='none'"
                    class="btn"
                    style="background: transparent; border: 1px solid var(--border); color: var(--text-secondary);">Cancel</button>
                <button type="submit" class="btn btn-primary" style="flex: 1;">Create & Continue</button>
            </div>
        </form>
    </div>
</div>


<!-- View Quiz Modal -->
<div id="viewQuizModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
    <div class="glass-card" style="width: 600px; max-width: 90%; max-height: 80vh; overflow-y: auto;">
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem;">
            <h3 id="viewQuizTitle" style="margin: 0; color: white;">Quiz Preview</h3>
            <button onclick="document.getElementById('viewQuizModal').style.display='none'"
                style="background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.5rem;">&times;</button>
        </div>
        <div id="viewQuizContent" style="color: var(--text-primary);">
            <!-- Questions will be populated here -->
        </div>
    </div>
</div>

<!-- View Assignment Modal -->
<div id="viewAssignmentModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
    <div class="glass-card" style="width: 500px; max-width: 90%;">
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem;">
            <h3 style="margin: 0; color: white;">Assignment Details</h3>
            <button onclick="document.getElementById('viewAssignmentModal').style.display='none'"
                style="background: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.5rem;">&times;</button>
        </div>

        <div style="margin-bottom: 1.5rem;">
            <h4 style="color: var(--accent); margin-bottom: 0.5rem;">Instructions</h4>
            <div id="viewAssignInstr"
                style="color: var(--text-primary); background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 6px; white-space: pre-wrap;">
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
            <div>
                <h4
                    style="color: var(--accent); margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                    Max Score</h4>
                <div id="viewAssignScore" style="color: white; font-size: 1.25rem; font-weight: 600;"></div>
            </div>
            <div>
                <h4
                    style="color: var(--accent); margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                    Attached Resource</h4>
                <div id="viewAssignFile" style="color: white; word-break: break-all;"></div>
            </div>
        </div>

        <div style="text-align: right;">
            <button onclick="document.getElementById('viewAssignmentModal').style.display='none'" class="btn"
                style="background: var(--border); color: white;">Close</button>
        </div>
    </div>
</div>

<!-- Edit Lesson Modal -->
<div id="editLessonModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
    <div class="glass-card" style="width: 500px; max-width: 90%;">
        <h3 style="margin-top: 0;">Edit Lesson</h3>
        <form id="editLessonForm" method="POST">
            <div class="form-group" style="margin-bottom: 1rem;">
                <label>Lesson Title</label>
                <input type="text" id="editLessonTitle" name="title" required class="form-control"
                    style="width: 100%; padding: 0.8rem; background: var(--bg-color); border: 1px solid var(--border); color: white; border-radius: 6px;">
            </div>
            <div class="form-group" style="margin-bottom: 2rem;">
                <label>Video URL</label>
                <input type="text" id="editLessonVideoUrl" name="video_url" class="form-control"
                    style="width: 100%; padding: 0.8rem; background: var(--bg-color); border: 1px solid var(--border); color: white; border-radius: 6px;">
            </div>
            <div style="display: flex; gap: 1rem;">
                <button type="button" onclick="document.getElementById('editLessonModal').style.display='none'"
                    class="btn"
                    style="background: transparent; border: 1px solid var(--border); color: var(--text-secondary);">Cancel</button>
                <button type="submit" class="btn btn-primary" style="flex: 1;">Update Lesson</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Method Modal -->
<div id="deleteModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1100; justify-content: center; align-items: center;">
    <div class="glass-card" style="width: 400px; max-width: 90%; text-align: center;">
        <div style="margin-bottom: 1.5rem;">
            <div
                style="width: 60px; height: 60px; background: rgba(220, 38, 38, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                <span style="color: var(--error); font-size: 2rem;">&times;</span>
            </div>
            <h3 style="margin: 0; margin-bottom: 0.5rem; color: white;">Confirm Deletion</h3>
            <p id="deleteMessage" style="color: var(--text-secondary); margin: 0;">Are you sure you want to delete this
                item?</p>
        </div>

        <div style="display: flex; gap: 1rem;">
            <button onclick="document.getElementById('deleteModal').style.display='none'" class="btn"
                style="flex: 1; background: transparent; border: 1px solid var(--border); color: var(--text-secondary);">Cancel</button>
            <form id="deleteForm" method="POST" style="flex: 1; margin: 0;">
                <button type="submit" class="btn btn-danger" style="width: 100%;">Delete</button>
            </form>
        </div>
    </div>
</div>

<script>
    // Initialize Event Listeners for Dynamic Edit Buttons
    document.addEventListener('DOMContentLoaded', function () {
        // Add click events to all edit buttons
        // Add click events to all edit buttons
        const editBtns = document.querySelectorAll('.edit-assignment-btn');
        editBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                openEditAssignmentModal(
                    this.getAttribute('data-id'),
                    this.getAttribute('data-score'),
                    this.getAttribute('data-instructions'),
                    this.getAttribute('data-resource')
                );
            });
        });

        // Initialize View Assignment Buttons
        const viewAssignBtns = document.querySelectorAll('.view-assignment-btn');
        viewAssignBtns.forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                const instructions = this.getAttribute('data-instructions');
                const score = this.getAttribute('data-score');
                const resource = this.getAttribute('data-resource');
                const resourceUrl = this.getAttribute('data-resource-url');

                document.getElementById('viewAssignInstr').innerText = instructions;
                document.getElementById('viewAssignScore').innerText = score;

                const fileEl = document.getElementById('viewAssignFile');
                if (resource && resource !== 'None' && resource !== '') {
                    fileEl.innerHTML = `<a href="${resourceUrl}" target="_blank" style="color: var(--accent); text-decoration: underline;">${resource}</a>`;
                } else {
                    fileEl.innerHTML = '<span style="color: var(--text-secondary);">No file attached</span>';
                }

                document.getElementById('viewAssignmentModal').style.display = 'flex';
            });
        });
    });
    function openEditLessonModal(id, title, videoUrl) {
        document.getElementById('editLessonTitle').value = title;
        document.getElementById('editLessonVideoUrl').value = videoUrl || '';
        document.getElementById('editLessonForm').action = "/admin/lesson/" + id + "/edit";
        document.getElementById('editLessonModal').style.display = 'flex';
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
        if (event.target == document.getElementById('editLessonModal')) {
            document.getElementById('editLessonModal').style.display = "none";
        }
        if (event.target == document.getElementById('deleteModal')) {
            document.getElementById('deleteModal').style.display = "none";
        }
        // ... existing close logic for other modals ...
    }

    function openDeleteModal(url, message) {
        const modal = document.getElementById('deleteModal');
        const form = document.getElementById('deleteForm');
        const msgEl = document.getElementById('deleteMessage');

        form.action = url;
        if (message) {
            msgEl.innerText = message;
        } else {
            msgEl.innerText = "Are you sure you want to delete this item? This action cannot be undone.";
        }

        modal.style.display = 'flex';
    }

    function openQuickAddModal(type) {
        const modal = document.getElementById('quickAddModal');
        const title = document.getElementById('quickAddTitle');
        const typeInput = document.getElementById('quickAddType');

        typeInput.value = type;
        title.innerText = type === 'quiz' ? 'Create New Quiz' : 'Create New Assignment';
        modal.style.display = 'flex';
    }

    function viewQuiz(title, questionsJson) {
        const modal = document.getElementById('viewQuizModal');
        const titleEl = document.getElementById('viewQuizTitle');
        const contentEl = document.getElementById('viewQuizContent');

        titleEl.innerText = title;
        contentEl.innerHTML = ''; // Clear previous content

        try {
            const questions = JSON.parse(questionsJson);

            if (questions.length === 0) {
                contentEl.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No questions added yet.</p>';
            } else {
                questions.forEach((q, index) => {
                    // Options are already a JSON string in the dictionary if they were stored that way, 
                    // BUT self.options in model is a JSON string.
                    // In to_dict I passed self.options directly. So it is still a string.
                    const options = typeof q.options === 'string' ? JSON.parse(q.options) : q.options;
                    let optionsHtml = '';
                    options.forEach((opt, i) => {
                        const isCorrect = i === q.correct_option;
                        const style = isCorrect ? 'color: var(--success); font-weight: bold;' : 'color: var(--text-secondary);';
                        const check = isCorrect ? '&#10003;' : '';
                        optionsHtml += `<li style="${style} margin-bottom: 0.2rem;">${String.fromCharCode(65 + i)}. ${opt} ${check}</li>`;
                    });

                    const html = `
                        <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h5 style="margin: 0; margin-bottom: 0.5rem; color: var(--accent);">Q${index + 1}: ${q.text}</h5>
                            <ul style="list-style: none; padding-left: 1rem; margin: 0;">${optionsHtml}</ul>
                        </div>
                    `;
                    contentEl.insertAdjacentHTML('beforeend', html);
                });
            }
        } catch (e) {
            console.error(e);
            contentEl.innerHTML = '<p style="color: var(--error);">Error loading quiz data.</p>';
        }

        modal.style.display = 'flex';
    }

    function openAddAssignmentModal(lessonId) {
        const modal = document.getElementById('assignmentModal');
        const form = document.getElementById('assignmentForm');

        document.getElementById('modalTitle').innerText = "Add Assignment";
        document.getElementById('modalSubmitBtn').innerText = "Create Assignment";
        document.getElementById('assignScore').value = "100";
        document.getElementById('assignInstr').value = "";

        // Hide current file display
        document.getElementById('currentResourceFile').style.display = 'none';

        form.action = `/admin/lesson/${lessonId}/add_assignment`;
        modal.style.display = 'flex';
    }

    function openEditAssignmentModal(assignmentId, score, instructions, resourcePath) {
        const modal = document.getElementById('assignmentModal');
        const form = document.getElementById('assignmentForm');

        document.getElementById('modalTitle').innerText = "Edit Assignment";
        document.getElementById('modalSubmitBtn').innerText = "Update Assignment";
        document.getElementById('assignScore').value = score;
        document.getElementById('assignInstr').value = instructions;

        // Show current file if exists
        const fileDisplay = document.getElementById('currentResourceFile');
        const fileNameSpan = document.getElementById('currentFileName');

        if (resourcePath && resourcePath !== 'None' && resourcePath !== '') {
            fileDisplay.style.display = 'block';
            fileNameSpan.innerText = resourcePath;
        } else {
            fileDisplay.style.display = 'none';
        }

        form.action = `/admin/assignment/${assignmentId}/edit`;
        modal.style.display = 'flex';
    }
</script>
{% endif %}

<script>
    // SHARED SCRIPTS (Student & Admin)

    // Tab Switching Logic
    function switchTab(tabName) {
        // Hide all content
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        // Show selected content
        document.getElementById('content-' + tabName).style.display = 'block';

        // Update Admin Tabs (if present)
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.style.color = 'var(--text-secondary)';
            btn.style.borderBottom = '2px solid transparent';
            btn.classList.remove('active');
        });

        const activeBtn = document.getElementById('tab-' + tabName);
        if (activeBtn) {
            activeBtn.style.color = 'white';
            activeBtn.style.borderBottom = '2px solid var(--accent)';
            activeBtn.classList.add('active');
        }

        // Update Sidebar Tabs (Student)
        document.querySelectorAll('.sidebar-tab').forEach(btn => {
            btn.classList.remove('active');
            btn.style.background = 'transparent';
            btn.style.color = 'var(--text-secondary)';
            btn.style.borderLeft = '3px solid transparent';
        });

        const activeSidebarBtn = document.getElementById('sidebar-tab-' + tabName);
        if (activeSidebarBtn) {
            activeSidebarBtn.classList.add('active');
            activeSidebarBtn.style.background = 'rgba(56, 139, 253, 0.1)';
            activeSidebarBtn.style.color = 'white';
            activeSidebarBtn.style.borderLeft = '3px solid var(--accent)';
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Initialize View Assignment Buttons (Shared)
        const viewAssignBtns = document.querySelectorAll('.view-assignment-btn');
        viewAssignBtns.forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                const instructions = this.getAttribute('data-instructions');
                const score = this.getAttribute('data-score');
                const resource = this.getAttribute('data-resource');
                const resourceUrl = this.getAttribute('data-resource-url');

                document.getElementById('viewAssignInstr').innerText = instructions;
                document.getElementById('viewAssignScore').innerText = score;

                const fileEl = document.getElementById('viewAssignFile');
                if (resource && resource !== 'None' && resource !== '') {
                    fileEl.innerHTML = `<a href="${resourceUrl}" target="_blank" style="color: var(--accent); text-decoration: underline;">${resource}</a>`;
                } else {
                    fileEl.innerHTML = '<span style="color: var(--text-secondary);">No file attached</span>';
                }

                document.getElementById('viewAssignmentModal').style.display = 'flex';
            });
        });
    });
</script>

{% endblock %}