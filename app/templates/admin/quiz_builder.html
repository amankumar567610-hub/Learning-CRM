{% extends "base.html" %}

{% block title %}Quiz Builder - Admin{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <div style="margin-bottom: 0.5rem;">
            <a href="{{ url_for('admin_bp.course_content', course_id=lesson.module.course.id) }}"
                class="text-muted text-sm"
                style="text-decoration: none; display: flex; align-items: center; gap: 0.5rem;">
                <span class="iconify" data-icon="heroicons:arrow-left"></span> Back to Course
            </a>
        </div>
        <h1 class="page-title gradient-text">Quiz Builder</h1>
        <p class="text-muted">Lesson: {{ lesson.title }}</p>
    </div>
</div>

<div class="glass-card" style="max-width: 800px; margin: 0 auto; padding: 2rem;">
    <form action="{{ url_for('admin_bp.add_quiz', lesson_id=lesson.id) }}" method="POST" id="quizForm">
        <div class="form-group" style="margin-bottom: 2rem;">
            <label>Quiz Title</label>
            <input type="text" name="title" class="form-control" value="{{ quiz.title if quiz else '' }}" required
                placeholder="e.g. Module Review" style="font-size: 1.1rem; padding: 1rem;">
        </div>

        <div id="questions-container">
            <!-- JS populates this -->
        </div>

        <button type="button" class="btn btn-outline hover-scale" onclick="addQuestion()"
            style="width: 100%; margin-top: 1.5rem; border: 2px dashed rgba(255,255,255,0.1); padding: 1rem; color: var(--text-secondary);">
            <span class="iconify" data-icon="heroicons:plus"></span> Add Question
        </button>

        <div
            style="margin-top: 2.5rem; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 1.5rem; text-align: right;">
            <button type="submit" class="btn btn-primary"
                style="min-width: 150px; font-size: 1.1rem; padding: 0.75rem 2rem;">Save Quiz</button>
        </div>
    </form>
</div>

<script>
    let questionCount = 0;

    function addQuestion(text = '', options = ['', '', '', ''], correct = 0) {
        questionCount++;
        const container = document.getElementById('questions-container');

        const html = `
            <div class="glass-card question-block" style="margin-bottom: 1.5rem; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.2);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                    <h4 style="margin: 0; color: var(--accent); display: flex; align-items: center; gap: 0.5rem;">
                        <span class="badge badge-primary" style="width: 24px; height: 24px; border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center;">${questionCount}</span>
                        Question Text
                    </h4>
                    <button type="button" class="btn btn-xs btn-danger" onclick="this.closest('.question-block').remove()" title="Remove">
                        <span class="iconify" data-icon="heroicons:trash"></span>
                    </button>
                </div>
                
                <div class="form-group">
                    <input type="text" name="questions[${questionCount}][text]" value="${text}" required placeholder="Enter question..." class="form-control">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                     ${options.map((opt, i) => `
                        <input type="text" name="questions[${questionCount}][options][]" value="${opt}" required placeholder="Option ${String.fromCharCode(65 + i)}" class="form-control">
                     `).join('')}
                </div>

                <div class="form-group" style="display: flex; align-items: center; gap: 1rem; background: rgba(255,255,255,0.02); padding: 0.75rem; border-radius: var(--radius-sm);">
                    <label class="text-sm text-muted" style="margin: 0;">Correct Answer:</label>
                    <select name="questions[${questionCount}][correct]" class="form-control" style="width: auto; padding: 0.4rem 2rem 0.4rem 1rem;">
                        <option value="0" ${correct == 0 ? 'selected' : ''}>Option A</option>
                        <option value="1" ${correct == 1 ? 'selected' : ''}>Option B</option>
                        <option value="2" ${correct == 2 ? 'selected' : ''}>Option C</option>
                        <option value="3" ${correct == 3 ? 'selected' : ''}>Option D</option>
                    </select>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }

    document.addEventListener('DOMContentLoaded', () => {
        {% if existing_questions %}
        {% for q in existing_questions %}
        addQuestion({{ q.text | tojson }}, {{ q.options | tojson }}, {{ q.correct }});
    {% endfor %}
    {% else %}
    addQuestion();
    {% endif %}
    });
</script>
{% endblock %}