{% extends "base.html" %}

{% block title %}Manage Courses - Admin{% endblock %}

{% block content %}
<div class="modern-page-header">
    <div class="header-content">
        <h1 class="header-title">Manage Courses</h1>
        <p class="header-subtitle">Create and manage your video courses.</p>
    </div>
    <div class="header-actions">
        <!-- Future: Add 'Create New Course' button here if we want to move it out of the sidebar -->
    </div>
</div>

<div class="course-grid-layout">
    <!-- Create Course Form -->
    <div class="glass-card course-form-sidebar">
        <div class="card-header" style="border-bottom: 1px solid rgba(255,255,255,0.05); padding: 1.5rem;">
            <h3 style="margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                <span class="iconify" data-icon="heroicons:plus-circle" style="color: var(--primary);"></span>
                Create New Course
            </h3>
        </div>
        <div class="card-body">
            <form method="POST" action="" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="title">Course Title</label>
                    <input type="text" name="title" id="title" class="form-control" required
                        placeholder="e.g. Advanced Python Masterclass">
                </div>

                <div class="form-group">
                    <label for="category_id">Category</label>
                    <select name="category_id" id="category_id" required style="display: none;">
                        <option value="" disabled selected>Select a Category</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>

                    <!-- Custom Dropdown Trigger -->
                    <div class="custom-select-wrapper" id="categoryDropdown">
                        <div class="custom-select-trigger">
                            <span id="categoryTriggerText">Select a Category</span>
                            <span class="iconify" data-icon="heroicons:chevron-down"
                                style="transition: transform 0.2s;"></span>
                        </div>
                        <div class="custom-options">
                            {% for category in categories %}
                            <div class="custom-option" data-value="{{ category.id }}">{{ category.name }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        const wrapper = document.getElementById('categoryDropdown');
                        const trigger = wrapper.querySelector('.custom-select-trigger');
                        const options = wrapper.querySelectorAll('.custom-option');
                        const nativeSelect = document.getElementById('category_id');
                        const triggerText = document.getElementById('categoryTriggerText');
                        const icon = trigger.querySelector('.iconify');

                        // Toggle Dropdown
                        trigger.addEventListener('click', function (e) {
                            wrapper.classList.toggle('open');
                            icon.style.transform = wrapper.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0)';
                            e.stopPropagation(); // Prevent closing immediately
                        });

                        // Select Option
                        options.forEach(option => {
                            option.addEventListener('click', function () {
                                // Update UI
                                triggerText.textContent = this.textContent;
                                triggerText.style.color = 'var(--text-primary)';
                                wrapper.classList.remove('open');
                                icon.style.transform = 'rotate(0)';

                                // Update Active State
                                options.forEach(opt => opt.classList.remove('selected'));
                                this.classList.add('selected');

                                // Update Native Select (for form submission)
                                nativeSelect.value = this.dataset.value;
                            });
                        });

                        // Close on click outside
                        document.addEventListener('click', function (e) {
                            if (!wrapper.contains(e.target)) {
                                wrapper.classList.remove('open');
                                icon.style.transform = 'rotate(0)';
                            }
                        });
                    });

                    // File Upload Preview
                    function updateFileName(input) {
                        const fileNameDisplay = document.getElementById('fileNameDisplay');
                        if (input.files && input.files.length > 0) {
                            fileNameDisplay.textContent = input.files[0].name;
                            fileNameDisplay.style.color = 'var(--text-primary)';
                        } else {
                            fileNameDisplay.textContent = 'Choose Image';
                            fileNameDisplay.style.color = 'var(--text-secondary)';
                        }
                    }
                </script>

                <div class="form-group">
                    <label>Thumbnail Application</label>
                    <!-- Custom File Upload -->
                    <div class="file-upload-wrapper">
                        <input type="file" name="thumbnail_file" id="thumbnail_file" accept="image/*"
                            class="file-upload-input" onchange="updateFileName(this)">
                        <div class="file-upload-label">
                            <div class="file-upload-icon">
                                <span class="iconify" data-icon="heroicons:photo"></span>
                            </div>
                            <span id="fileNameDisplay"
                                style="font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Choose
                                Image</span>
                        </div>
                    </div>

                    <div class="text-center text-muted" style="font-size: 0.8rem; margin: 0.5rem 0;">- OR -</div>
                    <input type="text" name="thumbnail_url" id="thumbnail_url" class="form-control"
                        placeholder="https://..." style="font-size: 0.9rem;">
                </div>

                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea name="description" id="description" rows="5" class="form-control" required
                        placeholder="Detailed course description to attract students..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary hover-scale" style="width: 100%; justify-content: center;">
                    Create Course
                </button>
            </form>
        </div>
    </div>

    <!-- Course List -->
    <div>
        <h3 style="margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 500;">Existing Content</h3>
        {% if courses %}
        <div class="grid-layout" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
            {% for course in courses %}
            <div class="glass-card hover-scale"
                style="padding: 0; overflow: hidden; display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.05);">
                <div style="position: relative; height: 180px; overflow: hidden;">
                    {% if course.thumbnail_url %}
                    {% if course.thumbnail_url.startswith('http') %}
                    <img src="{{ course.thumbnail_url }}"
                        style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s;"
                        onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                    {% else %}
                    <img src="{{ url_for('static', filename='uploads/' + course.thumbnail_url) }}"
                        style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s;"
                        onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                    {% endif %}
                    {% else %}
                    <div
                        style="width: 100%; height: 100%; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); display: flex; align-items: center; justify-content: center;">
                        <span style="font-size: 3rem; font-weight: 800; color: rgba(255,255,255,0.05);">{{
                            course.title[:2] }}</span>
                    </div>
                    {% endif %}

                    <div
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, transparent 0%, rgba(15,23,42,0.9) 100%); pointer-events: none;">
                    </div>

                    <div style="position: absolute; bottom: 1rem; left: 1rem; z-index: 10;">
                        <span class="badge badge-primary" style="backdrop-filter: blur(4px);">{{ course.category.name
                            }}</span>
                    </div>

                    <button
                        onclick="openDeleteCourseModal('{{ url_for('admin_bp.delete_course', course_id=course.id) }}', '{{ course.title | replace("'", "\\'") }}')"
                        class="btn btn-sm btn-danger"
                        style="position: absolute; top: 10px; right: 10px; width: 34px; height: 34px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.1);"
                        title="Delete">
                        <span class="iconify" data-icon="heroicons:trash" style="font-size: 1rem;"></span>
                    </button>
                </div>

                <div style="padding: 1.5rem; flex: 1; display: flex; flex-direction: column;">
                    <h3 style="margin: 0 0 0.5rem 0; font-size: 1.15rem; line-height: 1.4; color: var(--text-primary);">
                        {{ course.title }}</h3>
                    <p class="text-muted"
                        style="font-size: 0.9rem; line-height: 1.6; margin-bottom: 1.5rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; flex: 1;">
                        {{ course.description }}
                    </p>

                    <a href="{{ url_for('admin_bp.course_content', course_id=course.id) }}" class="btn btn-outline"
                        style="width: 100%; justify-content: center; border-color: rgba(59, 130, 246, 0.5); color: var(--primary);">
                        <span class="iconify" data-icon="heroicons:pencil-square" style="margin-right: 0.5rem;"></span>
                        Manage Content
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="glass-card text-center" style="padding: 4rem;">
            <div
                style="width: 80px; height: 80px; background: rgba(255,255,255,0.03); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                <span class="iconify" data-icon="heroicons:academic-cap"
                    style="font-size: 2.5rem; color: var(--text-muted);"></span>
            </div>
            <p class="text-muted">No courses found. Create your first one!</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Delete Modal -->
<div id="deleteCourseModal" class="modal"
    style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 100; align-items: center; justify-content: center; padding: 1rem;">
    <div class="glass-card modalPop"
        style="width: 100%; max-width: 450px; padding: 2rem; border-color: var(--danger); box-shadow: 0 10px 40px rgba(239, 68, 68, 0.1);">
        <div style="text-align: center; margin-bottom: 1.5rem;">
            <div
                style="width: 60px; height: 60px; background: rgba(239, 68, 68, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: var(--danger);">
                <span class="iconify anime-pulse" data-icon="heroicons:exclamation-triangle"
                    style="font-size: 2rem;"></span>
            </div>
            <h3 style="margin: 0 0 0.5rem 0; color: white; font-size: 1.25rem;">Delete Course?</h3>
            <p class="text-muted">Are you sure you want to delete <strong id="delCourseTitle"
                    class="text-white"></strong>?</p>
            <p class="text-sm text-secondary" style="margin-top: 0.5rem;">This action is <strong>irreversible</strong>.
                All content will be lost.</p>
        </div>

        <form id="deleteCourseForm" method="POST">
            <div class="form-group"
                style="background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: var(--radius-sm);">
                <label style="display: flex; gap: 0.75rem; cursor: pointer; margin: 0; align-items: flex-start;">
                    <input type="checkbox" id="confirmDeleteCheck" onchange="toggleDeleteBtn()"
                        style="width: auto; margin-top: 3px;">
                    <span class="text-sm text-secondary" style="line-height: 1.4;">I understand that this action
                        involves permanent data loss.</span>
                </label>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="button" onclick="document.getElementById('deleteCourseModal').style.display='none'"
                    class="btn btn-ghost" style="flex: 1;">Cancel</button>
                <button type="submit" id="deleteCourseBtn" class="btn btn-danger" style="flex: 1;"
                    disabled>Delete</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openDeleteCourseModal(url, title) {
        document.getElementById('deleteCourseForm').action = url;
        document.getElementById('delCourseTitle').innerText = title;
        document.getElementById('confirmDeleteCheck').checked = false;
        toggleDeleteBtn();
        document.getElementById('deleteCourseModal').style.display = 'flex';
    }

    function toggleDeleteBtn() {
        document.getElementById('deleteCourseBtn').disabled = !document.getElementById('confirmDeleteCheck').checked;
    }

    window.onclick = function (e) {
        if (e.target == document.getElementById('deleteCourseModal')) {
            document.getElementById('deleteCourseModal').style.display = 'none';
        }
    }
</script>
{% endblock %}