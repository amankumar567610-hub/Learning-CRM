{% extends "base.html" %}

{% block title %}Submissions - Admin{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <div style="margin-bottom: 0.5rem;">
            <a href="{{ url_for('admin_bp.course_content', course_id=assignment.lesson.module.course.id) }}"
                class="text-muted text-sm"
                style="text-decoration: none; display: flex; align-items: center; gap: 0.5rem;">
                <span class="iconify" data-icon="heroicons:arrow-left"></span> Back to Course
            </a>
        </div>
        <h1 class="page-title gradient-text">Submissions</h1>
        <p class="text-muted">
            Assignment: <strong style="color: white;">{{ assignment.lesson.title }}</strong> &bull; Total: {{
            assignment.submissions|length }}
        </p>
    </div>
</div>

<div class="glass-card" style="padding: 0; overflow: hidden;">
    {% if assignment.submissions %}
    <div class="table-responsive">
        <table class="table" style="width: 100%; border-collapse: collapse;">
            <thead style="background: rgba(255,255,255,0.02);">
                <tr>
                    <th style="padding: 1rem 1.5rem; text-align: left;">Student</th>
                    <th style="padding: 1rem 1.5rem; text-align: left;">Submitted At</th>
                    <th style="padding: 1rem 1.5rem; text-align: left;">File</th>
                    <th style="padding: 1rem 1.5rem; text-align: left;">Grade</th>
                    <th style="padding: 1rem 1.5rem; text-align: right;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for submission in assignment.submissions %}
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.2s;">
                    <td style="padding: 1rem 1.5rem;">
                        <div style="font-weight: 500;">{{ submission.student.full_name }}</div>
                        <div class="text-xs text-muted">{{ submission.student.email }}</div>
                    </td>
                    <td style="padding: 1rem 1.5rem;" class="text-muted text-sm">
                        {{ submission.submitted_at.strftime('%Y-%m-%d %H:%M') }}
                    </td>
                    <td style="padding: 1rem 1.5rem;">
                        <a href="{{ url_for('main.download_submission', submission_id=submission.id) }}" target="_blank"
                            class="btn btn-sm" style="color: var(--primary); border-color: rgba(59, 130, 246, 0.3);">
                            <span class="iconify" data-icon="heroicons:arrow-down-tray"></span> Download
                        </a>
                    </td>
                    <td style="padding: 1rem 1.5rem;">
                        {% if submission.grade is not none %}
                        <span class="badge badge-success" style="font-size: 0.9rem;">{{ submission.grade }} / {{
                            assignment.max_score }}</span>
                        {% else %}
                        <span class="badge badge-warning">Pending</span>
                        {% endif %}
                    </td>
                    <td style="padding: 1rem 1.5rem; text-align: right; white-space: nowrap;">
                        <button
                            onclick="openGradeModal({{ submission.id }}, '{{ submission.grade or '' }}', `{{ submission.feedback or '' }}`)"
                            class="btn btn-sm btn-primary">
                            Grade
                        </button>
                        <button
                            onclick="openRejectModal('{{ url_for('main.reject_assignment', submission_id=submission.id) }}')"
                            class="btn btn-sm btn-danger">
                            Reject
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center text-muted" style="padding: 4rem;">
        <span class="iconify" data-icon="heroicons:inbox"
            style="font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.5;"></span>
        <p>No submissions yet.</p>
    </div>
    {% endif %}
</div>

<!-- Grade Modal -->
<div id="gradeModal" class="modal"
    style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 100; align-items: center; justify-content: center;">
    <div class="glass-card" style="width: 400px; padding: 2rem;">
        <h3 style="margin-top: 0;">Grade Submission</h3>
        <form id="gradeForm" method="POST">
            <div class="form-group">
                <label>Score (Max: {{ assignment.max_score }})</label>
                <input type="number" name="grade" id="gradeInput" max="{{ assignment.max_score }}" required
                    class="form-control">
            </div>
            <div class="form-group">
                <label>Feedback</label>
                <textarea name="feedback" id="feedbackInput" rows="4" class="form-control"
                    placeholder="Comments for the student..."></textarea>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:1.5rem;">
                <button type="button" class="btn btn-ghost" onclick="closeModals()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Grade</button>
            </div>
        </form>
    </div>
</div>

<!-- Reject Modal -->
<div id="rejectModal" class="modal"
    style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 100; align-items: center; justify-content: center;">
    <div class="glass-card" style="width: 400px; padding: 2rem; border-color: var(--danger);">
        <h3 class="text-danger" style="margin-top: 0;">Confirm Rejection</h3>
        <p class="text-muted">Are you sure? The student will be notified and asked to resubmit.</p>
        <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:1.5rem;">
            <button type="button" class="btn btn-ghost" onclick="closeModals()">Cancel</button>
            <form id="rejectForm" method="POST" style="margin:0;">
                <button type="submit" class="btn btn-danger">Reject</button>
            </form>
        </div>
    </div>
</div>

<script>
    function closeModals() {
        document.querySelectorAll('.modal').forEach(el => el.style.display = 'none');
    }

    function openGradeModal(id, grade, feedback) {
        const form = document.getElementById('gradeForm');
        form.action = `/admin/submission/${id}/grade`;
        document.getElementById('gradeInput').value = grade != 'None' ? grade : '';
        document.getElementById('feedbackInput').value = feedback != 'None' ? feedback : '';
        document.getElementById('gradeModal').style.display = 'flex';
    }

    function openRejectModal(url) {
        document.getElementById('rejectForm').action = url;
        document.getElementById('rejectModal').style.display = 'flex';
    }

    window.onclick = function (e) {
        if (e.target.classList.contains('modal')) closeModals();
    }
</script>
{% endblock %}